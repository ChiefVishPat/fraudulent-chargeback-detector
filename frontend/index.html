<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fraud Detection System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8" x-data="fraudDetectionApp()">
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">üõ°Ô∏è Fraud Detection System</h1>
            <p class="text-gray-600">ML-powered credit card fraud detection using RandomForest, LightGBM, and XGBoost</p>
        </header>

        <!-- Notification Area -->
        <div class="fixed top-4 right-4 z-50 space-y-2" style="max-width: 400px;">
            <template x-for="notification in notifications" :key="notification.id">
                <div x-show="notification.show" 
                     x-transition:enter="transition ease-out duration-300"
                     x-transition:enter-start="opacity-0 transform scale-90"
                     x-transition:enter-end="opacity-100 transform scale-100"
                     x-transition:leave="transition ease-in duration-200"
                     x-transition:leave-start="opacity-100 transform scale-100"
                     x-transition:leave-end="opacity-0 transform scale-90"
                     :class="{
                         'bg-green-50 border-green-200 text-green-800': notification.type === 'success',
                         'bg-red-50 border-red-200 text-red-800': notification.type === 'error',
                         'bg-blue-50 border-blue-200 text-blue-800': notification.type === 'info',
                         'bg-yellow-50 border-yellow-200 text-yellow-800': notification.type === 'warning'
                     }"
                     class="border rounded-lg p-4 shadow-lg">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <span x-show="notification.type === 'success'">‚úÖ</span>
                            <span x-show="notification.type === 'error'">‚ùå</span>
                            <span x-show="notification.type === 'info'">‚ÑπÔ∏è</span>
                            <span x-show="notification.type === 'warning'">‚ö†Ô∏è</span>
                        </div>
                        <div class="ml-3 flex-1">
                            <p class="text-sm font-medium" x-text="notification.title"></p>
                            <p x-show="notification.message" class="text-sm mt-1" x-text="notification.message"></p>
                        </div>
                        <button @click="dismissNotification(notification.id)" class="ml-4 text-gray-400 hover:text-gray-600">
                            <span class="sr-only">Close</span>
                            <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </template>
        </div>

        <!-- Navigation Tabs -->
        <div class="mb-8">
            <nav class="flex space-x-4 border-b border-gray-200">
                <button @click="activeTab = 'training'" 
                        :class="activeTab === 'training' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                        class="py-2 px-4 border-b-2 font-medium text-sm transition-colors">
                    Model Training
                </button>
                <button @click="activeTab = 'prediction'; if (activeTab === 'prediction' && testTransactions.length === 0) loadTestTransactions()" 
                        :class="activeTab === 'prediction' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                        class="py-2 px-4 border-b-2 font-medium text-sm transition-colors">
                    Test Predictions
                </button>
                <button @click="activeTab = 'metrics'" 
                        :class="activeTab === 'metrics' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                        class="py-2 px-4 border-b-2 font-medium text-sm transition-colors">
                    Model Metrics
                </button>
                <button @click="activeTab = 'info'" 
                        :class="activeTab === 'info' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                        class="py-2 px-4 border-b-2 font-medium text-sm transition-colors">
                    System Info
                </button>
            </nav>
        </div>

        <!-- Training Tab -->
        <div x-show="activeTab === 'training'" class="space-y-6">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-2xl font-bold mb-4">Train Models</h2>
                
                <form @submit.prevent="trainModels" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Train Size</label>
                            <input type="number" x-model="trainingConfig.train_size" 
                                   min="0.5" max="0.7" step="0.05"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-500 mt-1">50-70% for training</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Validation Size</label>
                            <input type="number" x-model="trainingConfig.val_size" 
                                   min="0.15" max="0.25" step="0.05"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-500 mt-1">15-25% for validation</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Test Size</label>
                            <input type="number" x-model="trainingConfig.test_size" 
                                   min="0.15" max="0.25" step="0.05"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-500 mt-1">15-25% for testing</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Use SMOTE</label>
                            <select x-model="trainingConfig.use_smote" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="true">Yes (Recommended)</option>
                                <option value="false">No</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Handle imbalanced data</p>
                        </div>
                        <div x-show="trainingConfig.use_smote === 'true'">
                            <label class="block text-sm font-medium text-gray-700 mb-2">SMOTE Strategy</label>
                            <select x-model="trainingConfig.smote_strategy" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="auto">Auto (Recommended)</option>
                                <option value="minority">Minority Only</option>
                                <option value="all">All Classes</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Resampling strategy</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Random State</label>
                            <input type="number" x-model="trainingConfig.random_state"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-500 mt-1">For reproducibility</p>
                        </div>
                    </div>
                    
                    <button type="submit" :disabled="trainingStatus.status === 'training'"
                            class="w-full md:w-auto px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors">
                        <span x-show="trainingStatus.status !== 'training'" class="flex items-center justify-center">
                            üöÄ Start Training
                        </span>
                        <span x-show="trainingStatus.status === 'training'" class="flex items-center justify-center">
                            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 818-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 714 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Training in Progress...
                        </span>
                    </button>
                </form>

                <!-- Load Models Button -->
                <div class="mt-4">
                    <button type="button" @click="loadExistingModels" :disabled="loadingModels"
                            class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors">
                        <span x-show="!loadingModels" class="flex items-center justify-center">
                            üì¶ Load Existing Models
                        </span>
                        <span x-show="loadingModels" class="flex items-center justify-center">
                            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 818-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 714 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Loading Models...
                        </span>
                    </button>
                </div>

                <!-- Training Progress -->
                <div x-show="trainingStatus.status === 'training'" 
                     x-transition:enter="transition ease-out duration-300"
                     x-transition:enter-start="opacity-0 transform scale-95"
                     x-transition:enter-end="opacity-100 transform scale-100"
                     class="mt-6">
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-6 shadow-lg">
                        <div class="flex items-center mb-4">
                            <svg class="animate-spin h-5 w-5 text-blue-600 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 818-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 714 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <div class="flex-1">
                                <h3 class="font-semibold text-blue-900 text-lg">Training ML Models</h3>
                                <p class="text-sm text-blue-700">Processing fraud detection algorithms...</p>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-blue-800" x-text="`${Math.round(trainingStatus.progress)}%`"></div>
                                <div class="text-xs text-blue-600">Complete</div>
                            </div>
                        </div>
                        
                        <!-- Enhanced Progress Bar -->
                        <div class="w-full bg-gray-200 rounded-full h-4 mb-4 shadow-inner">
                            <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-4 rounded-full transition-all duration-700 ease-out relative overflow-hidden shadow-sm" 
                                 :style="`width: ${Math.min(trainingStatus.progress, 100)}%`">
                                <!-- Animated shine effect -->
                                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white to-transparent opacity-30 animate-pulse"></div>
                                <!-- Moving highlight -->
                                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-blue-300 to-transparent opacity-50 transform -skew-x-12 animate-pulse"></div>
                            </div>
                        </div>
                        
                        <!-- Progress Steps -->
                        <div class="grid grid-cols-5 gap-2 mb-4">
                            <div class="text-center">
                                <div :class="trainingStatus.progress >= 10 ? 'bg-green-500' : 'bg-gray-300'" class="w-3 h-3 rounded-full mx-auto mb-1 transition-colors duration-300"></div>
                                <div class="text-xs text-gray-600">Load Data</div>
                            </div>
                            <div class="text-center">
                                <div :class="trainingStatus.progress >= 30 ? 'bg-green-500' : 'bg-gray-300'" class="w-3 h-3 rounded-full mx-auto mb-1 transition-colors duration-300"></div>
                                <div class="text-xs text-gray-600">Process</div>
                            </div>
                            <div class="text-center">
                                <div :class="trainingStatus.progress >= 60 ? 'bg-green-500' : 'bg-gray-300'" class="w-3 h-3 rounded-full mx-auto mb-1 transition-colors duration-300"></div>
                                <div class="text-xs text-gray-600">Train</div>
                            </div>
                            <div class="text-center">
                                <div :class="trainingStatus.progress >= 80 ? 'bg-green-500' : 'bg-gray-300'" class="w-3 h-3 rounded-full mx-auto mb-1 transition-colors duration-300"></div>
                                <div class="text-xs text-gray-600">Evaluate</div>
                            </div>
                            <div class="text-center">
                                <div :class="trainingStatus.progress >= 95 ? 'bg-green-500' : 'bg-gray-300'" class="w-3 h-3 rounded-full mx-auto mb-1 transition-colors duration-300"></div>
                                <div class="text-xs text-gray-600">Save</div>
                            </div>
                        </div>
                        
                        <!-- Current Status Message -->
                        <div class="bg-white rounded-lg p-3 mb-4 border-l-4 border-blue-500">
                            <p class="text-sm font-medium text-blue-900" x-text="trainingStatus.message"></p>
                        </div>
                        
                        <!-- Time Estimate -->
                        <div class="flex items-center justify-between text-xs text-blue-600 bg-blue-100 rounded-lg p-3">
                            <div class="flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span><strong>Expected Duration:</strong> 5-15 minutes</span>
                            </div>
                            <div class="flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                                </svg>
                                <span><strong>Dataset:</strong> ~500MB processing</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Training Results -->
                <div x-show="trainingStatus.status === 'completed'" class="mt-6">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h3 class="font-medium text-green-900 mb-2">‚úÖ Training Completed</h3>
                        <p class="text-sm text-green-700" x-text="trainingStatus.message"></p>
                        <div x-show="trainingStatus.best_model" class="mt-2">
                            <span class="text-sm font-medium text-green-800">Best Model: </span>
                            <span class="text-sm text-green-700" x-text="trainingStatus.best_model"></span>
                        </div>
                    </div>
                </div>

                <!-- Training Error -->
                <div x-show="trainingStatus.status === 'failed'" class="mt-6">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <h3 class="font-medium text-red-900 mb-2">‚ùå Training Failed</h3>
                        <p class="text-sm text-red-700" x-text="trainingStatus.message"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- NEW Prediction Tab -->
        <div x-show="activeTab === 'prediction'" class="space-y-6">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold">Test Fraud Prediction</h2>
                        <p class="text-gray-600 mt-1">Select real transactions from the test dataset to see model performance</p>
                    </div>
                    <button @click="loadTestTransactions" :disabled="loadingTransactions"
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors">
                        <span x-show="!loadingTransactions">üîÑ Load Transactions</span>
                        <span x-show="loadingTransactions" class="flex items-center">
                            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 818-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 714 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Loading...
                        </span>
                    </button>
                </div>

                <!-- Filter Controls -->
                <div class="bg-gray-50 border rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-3">Filter Transactions</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Show Transactions</label>
                            <select x-model="transactionFilters.fraud_only" @change="loadTestTransactions"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option :value="null">All Transactions</option>
                                <option :value="true">Fraud Only</option>
                                <option :value="false">Legitimate Only</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Transactions per Page</label>
                            <select x-model="transactionFilters.limit" @change="loadTestTransactions"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Include Predictions</label>
                            <select x-model="transactionFilters.include_predictions" @change="loadTestTransactions"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option :value="false">No</option>
                                <option :value="true">Yes</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button @click="loadRandomTransactions" :disabled="loadingTransactions"
                                    class="w-full px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors">
                                üé≤ Random Sample
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Dataset Statistics -->
                <div x-show="testDataStats" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-medium text-blue-900 mb-2">Dataset Statistics</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div>
                            <span class="font-medium text-blue-700">Total Transactions:</span>
                            <span x-text="testDataStats?.total_transactions?.toLocaleString()"></span>
                        </div>
                        <div>
                            <span class="font-medium text-blue-700">Fraud:</span>
                            <span x-text="testDataStats?.fraud_transactions?.toLocaleString()"></span>
                        </div>
                        <div>
                            <span class="font-medium text-blue-700">Legitimate:</span>
                            <span x-text="testDataStats?.legitimate_transactions?.toLocaleString()"></span>
                        </div>
                        <div>
                            <span class="font-medium text-blue-700">Fraud Rate:</span>
                            <span x-text="(testDataStats?.fraud_rate * 100)?.toFixed(2) + '%'"></span>
                        </div>
                    </div>
                </div>

                <!-- Loading State -->
                <div x-show="loadingTransactions" class="text-center py-8">
                    <div class="inline-flex items-center">
                        <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 818-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 714 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="text-lg text-gray-600">Loading test transactions...</span>
                    </div>
                </div>

                <!-- Transaction Cards -->
                <div x-show="testTransactions && testTransactions.length > 0" class="space-y-4">
                    <template x-for="transaction in testTransactions" :key="transaction.trans_num">
                        <div class="border rounded-lg p-4 hover:shadow-md transition-shadow"
                             :class="{
                                 'border-red-200 bg-red-50': transaction.actual_fraud,
                                 'border-green-200 bg-green-50': !transaction.actual_fraud
                             }">
                            
                            <!-- Transaction Header -->
                            <div class="flex flex-wrap justify-between items-start mb-4">
                                <div class="flex items-center space-x-2 mb-2 md:mb-0">
                                    <span :class="{
                                        'bg-red-100 text-red-800': transaction.actual_fraud,
                                        'bg-green-100 text-green-800': !transaction.actual_fraud
                                    }" class="px-2 py-1 rounded-full text-xs font-medium">
                                        <span x-show="transaction.actual_fraud">üö® ACTUAL FRAUD</span>
                                        <span x-show="!transaction.actual_fraud">‚úÖ LEGITIMATE</span>
                                    </span>
                                    <span class="text-xs text-gray-500" x-text="transaction.trans_num"></span>
                                </div>
                                <div class="flex space-x-2">
                                    <button @click="predictSingleTransaction(transaction)" 
                                            :disabled="predictingTransaction === transaction.trans_num"
                                            class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors">
                                        <span x-show="predictingTransaction !== transaction.trans_num">üîç Test Prediction</span>
                                        <span x-show="predictingTransaction === transaction.trans_num" class="flex items-center">
                                            <svg class="animate-spin -ml-1 mr-1 h-3 w-3 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 818-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 714 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                            Testing...
                                        </span>
                                    </button>
                                </div>
                            </div>

                            <!-- Transaction Details -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <div class="text-sm">
                                        <span class="font-medium text-gray-700">Amount:</span>
                                        <span class="font-bold" :class="{
                                            'text-red-600': transaction.amt > 400,
                                            'text-yellow-600': transaction.amt > 100 && transaction.amt <= 400,
                                            'text-green-600': transaction.amt <= 100
                                        }" x-text="'$' + transaction.amt.toFixed(2)"></span>
                                    </div>
                                    <div class="text-sm">
                                        <span class="font-medium text-gray-700">Customer:</span>
                                        <span x-text="transaction.first + ' ' + transaction.last"></span>
                                    </div>
                                    <div class="text-sm">
                                        <span class="font-medium text-gray-700">Date:</span>
                                        <span x-text="new Date(transaction.trans_date_trans_time).toLocaleString()"></span>
                                    </div>
                                </div>
                                <div>
                                    <div class="text-sm">
                                        <span class="font-medium text-gray-700">Merchant:</span>
                                        <span x-text="transaction.merchant"></span>
                                    </div>
                                    <div class="text-sm">
                                        <span class="font-medium text-gray-700">Category:</span>
                                        <span class="capitalize" x-text="transaction.category.replace('_', ' ')"></span>
                                    </div>
                                    <div class="text-sm">
                                        <span class="font-medium text-gray-700">Location:</span>
                                        <span x-text="transaction.city + ', ' + transaction.state"></span>
                                    </div>
                                </div>
                                <div>
                                    <!-- Risk Indicators -->
                                    <div class="text-sm">
                                        <span class="font-medium text-gray-700">Risk Factors:</span>
                                        <div class="mt-1 space-y-1">
                                            <template x-for="indicator in transaction.risk_indicators" :key="indicator">
                                                <span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded text-xs mr-1 mb-1" x-text="indicator"></span>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Model Prediction Results (if available) -->
                            <div x-show="transaction.model_prediction || transaction.prediction_result" class="mt-4 pt-4 border-t border-gray-200">
                                <h4 class="font-medium text-gray-900 mb-2">Model Prediction</h4>
                                <div>
                                    <div class="flex items-center space-x-4 mb-2">
                                        <div class="flex items-center space-x-2">
                                            <span class="font-medium text-gray-700">Prediction:</span>
                                            <span :class="{
                                                'bg-red-100 text-red-800': (transaction.model_prediction || transaction.prediction_result)?.is_fraud,
                                                'bg-green-100 text-green-800': !(transaction.model_prediction || transaction.prediction_result)?.is_fraud
                                            }" class="px-2 py-1 rounded text-sm font-medium">
                                                <span x-show="(transaction.model_prediction || transaction.prediction_result)?.is_fraud">üö® FRAUD</span>
                                                <span x-show="!(transaction.model_prediction || transaction.prediction_result)?.is_fraud">‚úÖ SAFE</span>
                                            </span>
                                        </div>
                                        <div>
                                            <span class="font-medium text-gray-700">Probability:</span>
                                            <span class="font-bold" x-text="((transaction.model_prediction || transaction.prediction_result)?.fraud_probability * 100)?.toFixed(2) + '%'"></span>
                                        </div>
                                        <div>
                                            <span class="font-medium text-gray-700">Risk Level:</span>
                                            <span class="capitalize font-medium" x-text="(transaction.model_prediction || transaction.prediction_result)?.risk_level"></span>
                                        </div>
                                    </div>
                                    
                                    <!-- Accuracy Indicator -->
                                    <div x-show="transaction.model_prediction || transaction.prediction_result" class="flex items-center space-x-2">
                                        <span class="font-medium text-gray-700">Accuracy:</span>
                                        <span :class="{
                                            'bg-green-100 text-green-800': transaction.actual_fraud === (transaction.model_prediction || transaction.prediction_result)?.is_fraud,
                                            'bg-red-100 text-red-800': transaction.actual_fraud !== (transaction.model_prediction || transaction.prediction_result)?.is_fraud
                                        }" class="px-2 py-1 rounded text-sm font-medium">
                                            <span x-show="transaction.actual_fraud === (transaction.model_prediction || transaction.prediction_result)?.is_fraud">‚úÖ CORRECT</span>
                                            <span x-show="transaction.actual_fraud !== (transaction.model_prediction || transaction.prediction_result)?.is_fraud">‚ùå INCORRECT</span>
                                        </span>
                                        <span x-show="transaction.actual_fraud && !(transaction.model_prediction || transaction.prediction_result)?.is_fraud" class="text-red-600 text-sm font-medium">(False Negative)</span>
                                        <span x-show="!transaction.actual_fraud && (transaction.model_prediction || transaction.prediction_result)?.is_fraud" class="text-orange-600 text-sm font-medium">(False Positive)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Pagination -->
                <div x-show="testDataPagination && testDataPagination.total_count > 0" class="mt-6 flex items-center justify-between">
                    <div class="text-sm text-gray-700">
                        <span>Showing </span>
                        <span x-text="testDataPagination.offset + 1"></span>
                        <span> to </span>
                        <span x-text="Math.min(testDataPagination.offset + testDataPagination.limit, testDataPagination.total_count)"></span>
                        <span> of </span>
                        <span x-text="testDataPagination.total_count"></span>
                        <span> transactions</span>
                    </div>
                    <div class="flex space-x-2">
                        <button @click="loadPreviousPage" 
                                :disabled="loadingTransactions || testDataPagination.offset === 0"
                                class="px-3 py-1 bg-gray-600 text-white rounded text-sm hover:bg-gray-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors">
                            Previous
                        </button>
                        <button @click="loadNextPage" 
                                :disabled="loadingTransactions || !testDataPagination.has_more"
                                class="px-3 py-1 bg-gray-600 text-white rounded text-sm hover:bg-gray-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors">
                            Next
                        </button>
                    </div>
                </div>

                <!-- No Data State -->
                <div x-show="!loadingTransactions && (!testTransactions || testTransactions.length === 0)" class="text-center py-12">
                    <div class="mb-4">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No Transactions Available</h3>
                    <p class="text-sm text-gray-500 mb-4">Click "Load Transactions" to fetch test data from the dataset</p>
                </div>
            </div>
        </div>

        <!-- Keep other tabs as placeholders -->
        <div x-show="activeTab === 'metrics'" class="space-y-6">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-2xl font-bold mb-4">Model Performance Metrics</h2>
                <p class="text-gray-600">Metrics interface is preserved from the original implementation.</p>
            </div>
        </div>

        <div x-show="activeTab === 'info'" class="space-y-6">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-2xl font-bold mb-4">System Information</h2>
                <p class="text-gray-600">System info interface is preserved from the original implementation.</p>
            </div>
        </div>
    </div>

    <script>
        function fraudDetectionApp() {
            return {
                activeTab: 'training', // Start with training tab
                
                // Training
                trainingConfig: {
                    train_size: 0.6,
                    val_size: 0.2,
                    test_size: 0.2,
                    use_smote: 'true',
                    smote_strategy: 'auto',
                    random_state: 42
                },
                trainingStatus: {
                    status: 'idle',
                    progress: 0,
                    message: ''
                },
                loadingModels: false,
                
                // Notifications
                notifications: [],
                
                // NEW Test Data Variables
                testTransactions: [],
                testDataStats: null,
                testDataPagination: null,
                loadingTransactions: false,
                predictingTransaction: null,
                transactionFilters: {
                    fraud_only: null,
                    limit: 25,
                    include_predictions: false,
                    offset: 0
                },

                init() {
                    console.log('Fraud Detection App initialized with training and CSV prediction interface');
                    this.checkTrainingStatus();
                    if (this.activeTab === 'prediction') {
                        this.loadTestTransactions();
                    }
                },

                async checkTrainingStatus() {
                    try {
                        const response = await fetch('/training-status');
                        if (response.ok) {
                            this.trainingStatus = await response.json();
                        }
                    } catch (error) {
                        console.log('No existing training status:', error.message);
                    }
                },

                async trainModels() {
                    try {
                        // Validate split sizes sum to 1.0
                        const totalSize = parseFloat(this.trainingConfig.train_size) + 
                                        parseFloat(this.trainingConfig.val_size) + 
                                        parseFloat(this.trainingConfig.test_size);
                        
                        if (Math.abs(totalSize - 1.0) > 0.001) {
                            this.addNotification(
                                'Invalid Configuration',
                                `Split sizes must sum to 1.0, got ${totalSize.toFixed(3)}`,
                                'error'
                            );
                            return;
                        }
                        
                        // Immediately set training status to show loading
                        this.trainingStatus = { 
                            status: 'training', 
                            progress: 5, 
                            message: 'Initializing training process...' 
                        };
                        
                        // Convert use_smote to boolean
                        const config = {
                            ...this.trainingConfig,
                            train_size: parseFloat(this.trainingConfig.train_size),
                            val_size: parseFloat(this.trainingConfig.val_size),
                            test_size: parseFloat(this.trainingConfig.test_size),
                            use_smote: this.trainingConfig.use_smote === 'true',
                            random_state: parseInt(this.trainingConfig.random_state)
                        };
                        
                        const response = await fetch('/train', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(config)
                        });
                        
                        if (response.ok) {
                            this.trainingStatus = { status: 'training', progress: 0, message: 'Starting training with imbalanced data handling...' };
                            this.addNotification(
                                'Training Started',
                                'Model training has begun. This may take 5-15 minutes for large datasets.',
                                'info',
                                8000
                            );
                            this.pollTrainingStatus();
                        } else {
                            const error = await response.json();
                            this.trainingStatus = { status: 'failed', progress: 0, message: error.detail || 'Training failed' };
                            this.addNotification(
                                'Training Failed',
                                error.detail || 'Unable to start training process',
                                'error'
                            );
                        }
                    } catch (error) {
                        this.trainingStatus = { status: 'failed', progress: 0, message: error.message };
                        this.addNotification(
                            'Training Error',
                            `Failed to start training: ${error.message}`,
                            'error'
                        );
                    }
                },

                async pollTrainingStatus() {
                    const poll = async () => {
                        try {
                            const response = await fetch('/training-status');
                            if (response.ok) {
                                const newStatus = await response.json();
                                this.trainingStatus = newStatus;
                                
                                if (newStatus.status === 'training') {
                                    // Continue polling every 3 seconds during training
                                    setTimeout(poll, 3000);
                                } else if (newStatus.status === 'completed') {
                                    // Training completed
                                    this.addNotification(
                                        'Training Complete',
                                        `Training completed successfully! Best model: ${newStatus.best_model}`,
                                        'success',
                                        10000
                                    );
                                } else if (newStatus.status === 'failed') {
                                    // Training failed
                                    this.addNotification(
                                        'Training Failed',
                                        newStatus.message || 'Training failed with an error',
                                        'error'
                                    );
                                }
                            }
                        } catch (error) {
                            console.error('Error polling training status:', error);
                            // Stop polling on error
                        }
                    };
                    
                    // Start polling
                    setTimeout(poll, 3000);
                },

                async loadExistingModels() {
                    this.loadingModels = true;
                    try {
                        const response = await fetch('/models/info');
                        if (response.ok) {
                            const modelInfo = await response.json();
                            this.addNotification(
                                'Models Loaded',
                                `Loaded existing models. Best model: ${modelInfo.best_model}`,
                                'success'
                            );
                            // Update training status to show models are loaded
                            this.trainingStatus = {
                                status: 'completed',
                                progress: 100,
                                message: `Loaded existing models from ${modelInfo.last_trained}`,
                                best_model: modelInfo.best_model
                            };
                        } else {
                            this.addNotification(
                                'Load Failed',
                                'No existing models found. Please train new models.',
                                'warning'
                            );
                        }
                    } catch (error) {
                        this.addNotification(
                            'Load Error',
                            `Failed to load models: ${error.message}`,
                            'error'
                        );
                    } finally {
                        this.loadingModels = false;
                    }
                },

                // Notification methods
                addNotification(title, message, type = 'info', duration = 5000) {
                    const notification = {
                        id: Date.now() + Math.random(),
                        title,
                        message,
                        type,
                        show: true
                    };
                    
                    this.notifications.push(notification);
                    
                    if (duration > 0) {
                        setTimeout(() => {
                            this.dismissNotification(notification.id);
                        }, duration);
                    }
                },

                dismissNotification(id) {
                    const notification = this.notifications.find(n => n.id === id);
                    if (notification) {
                        notification.show = false;
                        setTimeout(() => {
                            this.notifications = this.notifications.filter(n => n.id !== id);
                        }, 300);
                    }
                },

                // NEW Test Data Methods
                async loadTestTransactions() {
                    this.loadingTransactions = true;
                    try {
                        const params = new URLSearchParams({
                            limit: this.transactionFilters.limit,
                            offset: this.transactionFilters.offset,
                            include_predictions: this.transactionFilters.include_predictions
                        });
                        
                        if (this.transactionFilters.fraud_only !== null) {
                            params.append('fraud_only', this.transactionFilters.fraud_only);
                        }
                        
                        const response = await fetch(`/test-data/samples?${params}`);
                        
                        if (response.ok) {
                            const data = await response.json();
                            this.testTransactions = data.transactions;
                            this.testDataStats = data.statistics;
                            this.testDataPagination = data.pagination;
                            
                            this.addNotification(
                                'Transactions Loaded',
                                `Loaded ${data.transactions.length} transactions from test dataset`,
                                'success',
                                3000
                            );
                        } else {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                    } catch (error) {
                        console.error('Error loading test transactions:', error);
                        this.addNotification(
                            'Load Failed',
                            `Failed to load test transactions: ${error.message}`,
                            'error'
                        );
                    } finally {
                        this.loadingTransactions = false;
                    }
                },

                async loadRandomTransactions() {
                    this.transactionFilters.offset = Math.floor(Math.random() * 1000);
                    await this.loadTestTransactions();
                },

                async loadNextPage() {
                    if (this.testDataPagination && this.testDataPagination.has_more) {
                        this.transactionFilters.offset += this.transactionFilters.limit;
                        await this.loadTestTransactions();
                    }
                },

                async loadPreviousPage() {
                    if (this.testDataPagination && this.testDataPagination.offset > 0) {
                        this.transactionFilters.offset = Math.max(0, this.transactionFilters.offset - this.transactionFilters.limit);
                        await this.loadTestTransactions();
                    }
                },

                async predictSingleTransaction(transaction) {
                    this.predictingTransaction = transaction.trans_num;
                    
                    try {
                        // Create transaction data without the actual_fraud and risk_indicators fields
                        const transactionData = Object.keys(transaction)
                            .filter(key => !['actual_fraud', 'risk_indicators', 'index', 'model_prediction'].includes(key))
                            .reduce((obj, key) => {
                                obj[key] = transaction[key];
                                return obj;
                            }, {});
                        
                        const response = await fetch('/predict', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                transactions: [transactionData]
                            })
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            
                            // Add prediction result to the transaction
                            const prediction = result.predictions[0];
                            transaction.prediction_result = prediction;
                            
                            // Show notification
                            const isCorrect = transaction.actual_fraud === prediction.is_fraud;
                            this.addNotification(
                                isCorrect ? 'Correct Prediction' : 'Incorrect Prediction',
                                `Model predicted ${prediction.is_fraud ? 'FRAUD' : 'SAFE'} (${(prediction.fraud_probability * 100).toFixed(2)}%). ${isCorrect ? 'Matches actual.' : 'Does not match actual.'}`,
                                isCorrect ? 'success' : 'warning',
                                6000
                            );
                            
                        } else {
                            const error = await response.json();
                            this.addNotification(
                                'Prediction Failed',
                                error.detail || 'Unable to predict transaction',
                                'error'
                            );
                        }
                    } catch (error) {
                        this.addNotification(
                            'Prediction Error',
                            `Failed to predict: ${error.message}`,
                            'error'
                        );
                    } finally {
                        this.predictingTransaction = null;
                    }
                }
            }
        }
    </script>
</body>
</html>